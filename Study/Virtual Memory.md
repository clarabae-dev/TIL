#### 가상 메모리  
> 가상 메모리는 RAM을 관리하는 방법의 하나로, 각 프로그램에 실제 메모리 주소가 아닌 가상의 메모리 주소를 주는 방식을 말한다. -위키백과-  
  
> 가상 메모리 기술은 사용자가 신경 쓸 필요 없이 OS 측에서 자동으로 작동하며 사용자가 프로세스를 올리고 내림에 있어서  
> 역시 사용자가 신경 쓸 필요 없이 OS의 가상 메모리를 활용하여 자동으로 메모리 관리를 위임할 수 있다는 장점이 있다. -나무위키-  
  
기기마다 RAM의 크기는 다르며, 각기 다른 RAM 시스템을 통일된 주소 시스템으로 추상화하는 기술을 Virtual Memory라 한다.  
가상 메모리 주소는 프로세서 아키텍쳐에 따라서만 제한된다. 32비트 프로세서는 4기가의 주소를, 64비트 프로세서는 18엑사바이트를 다룰 수 있다.  
  
그리고 iOS는 18엑사바이트만큼의 RAM 대신 가상 메모리 공간을 활용한다.  
앱의 모든 프로세스는 가상 메모리 공간을 확보하고 공간 내 모든 주소에 엑세스 할 수 있다.  
각 프로세스마다 가상 메모리의 통일된 주소 공간을 배정하기 때문에 메모리 관리가 단순화된다.  
모든 가상 메모리 공간은 가상 주소를 물리적 주소에 매핑한다.  
macOS와 달리 iOS는 백업 저장소가 없다. iOS는 메모리 데이터를 보관하기 위해 디스크를 사용하지 않기 때문에 시스템은 물리적인 RAM 크기로 제한된다.  
  
#### Clean and Dirty Pages  
가상 메모리는 페이지라는 청크 단위로 공간을 나눈다.(물리적 메모리는 프레임 단위로 나뉜다.) 페이지는 16KB 청크로 어떤 종류의 데이터든 보관할 수 있다.  
데이터는 여러 페이지에 보관될 수 있기 때문에 하나의 페이지는 한 종류 이상의 데이터를 보관할 수 있다.  
페이지는 Dirty, Clean이라는 타입으로 구분하고, 압축될 수도 있다.  
  
Clean 메모리는 디스크에 로드할 수 있고 프레임워크, 실행 코드와 읽기 전용 파일들을 보관한다.  
Dirty 메모리는 앱, 힙 할당, 싱글턴, 글로벌 이니셔라이저, 스택 등으로 쓰여진 메모리다.  
앱이 접근하지 않은 페이지 메모리는 압축되고, 접근 시 압축이 해제된다.  
사용 중인 메모리는 Dirty 메모리와 압축 메모리이다.  
Clean 메모리는 손실되더라도 코드나 저장소에서 언제든 복구할 수 있다.  
  
#### Dirty 메모리 줄이기  
Dirty 메모리를 줄이기 위해 기억해야 할 점은 앱에서 동적으로 생성하고 유지하는 데이터(=실제 사용중인 데이터)는 모두 Dirty 메모리라는 점이다.  
1. 변수 대신 상수를 사용할 것:  
Swift는 안정성 때문에 가능한한 let을 사용하도록 장려하는데, Dirty 메모리를 줄이는 측면에서도 let을 사용하는 것이 좋다.  
let으로 선언된 오브젝트는 앱 메모리에 카운팅되지 않는다. 코드의 일부라 보기 때문에 Clean 메모리로 여겨지기 때문이다.  
2. 로컬 저장소에 크기가 큰 데이터를 저장하고 필요할 때 로드할 것:  
캐시에 데이터를 저장하고 필요할 때마다 로드하면 Dirty 메모리를 확보할 수 있다.  
3. 스택에 변수들을 할당할 것:  
스택에 변수들을 할당한다는 뜻은 함수의 변수로 할당한다는 의미이다.  
Dirty 메모리로 카운팅되지만, 함수가 종료되면, 할당되었던 Dirty 메모리는 해제된다.  

![Alt text](https://goodgid.github.io/assets/img/posts/memory_structure_1.png)  
> 스택 영역은 함수 호출과 관계되는 지역변수와 매개변수가 저장되는 영역이다.  
> 함수가 호출될 때 할당되며, 호출이 완료되면 소멸한다. 이처럼 스택 영역에 저장되는 함수 호출 정보를 Stack Frame 이라 한다.  
> 프로그램이 자동으로 사용하는 임시 메모리 영역이다.  
  
4. 가장 작은 데이터 타입을 사용할 것:  
기본 Int 타입은 CPU에 따라 달라진다. 64비트 기기에서 Int의 기본 타입은 Int64이다. Int8/Int16을 활용한다.  
5. Lazy Loading을 사용할 것:  
실제 필요해질 때 오브젝트를 할당하는 것이 가장 좋은 방법이다. 이를 위해 Swift는 lazy 키워드로 변수를 선언한다.  
lazy로 선언된 변수는 초기에는 값이 존재하지 않고 이후에 사용될 때 연산하여 값이 생긴다.  
  
#### 가상 메모리 구조. 
Code 영역: 함수가 저장되는 곳.  
Data 영역: 전역 변수, static으로 선언한 지역 변수들이 저장되는 곳.
위 코드와 데이터 영역은 프로그램 시작부터 메모리 할당, 종료까지 특별한 변화가 없는 정적인 공간이다.  
Stack 영역: 함수 수행 중 잠깐 필요한 지역변수와 매개변수가 저장되는 곳.  
Heap 영역: 개발자가 필요에 따라 수시로 만들고 지우는 데이터들이 저장되는 곳.  

#### Automatic Reference Counting  
가상 메모리 구조에서 개발자가 직접 할당하고 해지하는 구간은 힙 영역이다.  
힙 영역은 참조형 데이터들을 보관하고 개발자가 동적으로 메모리에 접근하는 구역이라 관리가 필요하다.  
참조형 데이터들이 얼마나 참조되고 있는지 카운팅하고 이에 따라 메모리를 할당하거나 제거하는데, 이 과정을 자동으로 해주는 것이 ARC 이다.  
